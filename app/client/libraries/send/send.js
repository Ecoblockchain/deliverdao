Template.Send.events({
  'click #submitOrder': function() {

    var orderdata = {};
    orderdata['name'] = $('#name').val();
    orderdata['description'] = $('#description').val();
    orderdata['location'] = $('#location').val();
    orderdata['destination'] = $('#destination').val();
    orderdata['value'] = parseInt($('#value').val());
    orderdata['weight'] = parseInt($('#weight').val());
    orderdata['dimension'] = parseInt($('#dimension').val());
    orderdata['fee'] = parseInt($('#fee').val());
    orderdata['active'] = false;
    orderdata['shipper'] = "Shipper1";
    orderdata['courier'] = "";

    //
    // This is fairly stupid as we're launching a new DAO contract with each new order
    // this is obviously only for this Hackathon/Proof of Concept
    //
    var deliverdaoContract = web3.eth.contract([{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"proposals","outputs":[{"name":"name","type":"bytes32"},{"name":"description","type":"string"},{"name":"creator","type":"address"},{"name":"requestedAmount","type":"uint256"},{"name":"weightedVote","type":"uint256"},{"name":"threshold","type":"uint256"},{"name":"active","type":"bool"},{"name":"successful","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"id","type":"uint256"},{"name":"_value","type":"uint256"},{"name":"_fee","type":"uint256"}],"name":"makeOrder","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"_name","type":"bytes32"},{"name":"_address","type":"address"}],"name":"addCourier","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"id","type":"uint256"}],"name":"takeOrder","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"shippers","outputs":[{"name":"name","type":"bytes32"},{"name":"totalSent","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[{"name":"_name","type":"bytes32"},{"name":"_description","type":"string"},{"name":"_requestedAmount","type":"uint256"}],"name":"createProposal","outputs":[{"name":"proposal","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"_name","type":"bytes32"},{"name":"_address","type":"address"}],"name":"addShipper","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"id","type":"uint256"}],"name":"voteProposal","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"deliveries","outputs":[{"name":"courier","type":"address"},{"name":"shipper","type":"address"},{"name":"totalValue","type":"uint256"},{"name":"fee","type":"uint256"},{"name":"active","type":"bool"},{"name":"beingShipped","type":"bool"},{"name":"arrived","type":"bool"},{"name":"deposit","type":"uint256"},{"name":"deadline","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[{"name":"id","type":"uint256"}],"name":"requiredDeposit","outputs":[{"name":"depositAmount","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"id","type":"uint256"}],"name":"deadline","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"couriers","outputs":[{"name":"name","type":"bytes32"},{"name":"reputation","type":"uint256"},{"name":"totalDelivered","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"courierAddr","type":"address"},{"name":"rating","type":"uint256"}],"name":"leaveRating","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"id","type":"uint256"}],"name":"arrived","outputs":[],"type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"id","type":"uint256"}],"name":"newOrder","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"id","type":"uint256"},{"indexed":false,"name":"courier","type":"address"}],"name":"orderFulfilled","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"id","type":"uint256"},{"indexed":false,"name":"timestamp","type":"uint256"}],"name":"orderArrived","type":"event"}]);
    var deliverdao = deliverdaoContract.new(
       {
         from: web3.eth.accounts[0],
         data: '6060604052600060036000505561167b8061001a6000396000f3606060405236156100cc576000357c010000000000000000000000000000000000000000000000000000000090048063013cf08b146100ce57806319d616bc146101cb57806335a4b657146101f55780633b5d1a24146102165780634ed3959c1461022e5780634f353d82146102655780635be41939146102e1578063807896d514610302578063a9e4a3241461031a578063c258159b146103b0578063c40dc8ec146103dc578063ccd5fcb9146103f4578063e949509f14610432578063f2c46f7214610453576100cc565b005b6100e4600480803590602001909190505061046b565b6040518089600019168152602001806020018873ffffffffffffffffffffffffffffffffffffffff168152602001878152602001868152602001858152602001841515815260200183151581526020018281038252898181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156101b55780601f1061018a576101008083540402835291602001916101b5565b820191906000526020600020905b81548152906001019060200180831161019857829003601f168201915b5050995050505050505050505060405180910390f35b6101f360048080359060200190919080359060200190919080359060200190919050506104fe565b005b610214600480803590602001909190803590602001909190505061078c565b005b61022c600480803590602001909190505061081d565b005b61024460048080359060200190919050506109d6565b60405180836000191681526020018281526020019250505060405180910390f35b6102cb6004808035906020019091908035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091908035906020019091905050610a03565b6040518082815260200191505060405180910390f35b6103006004808035906020019091908035906020019091905050610e19565b005b6103186004808035906020019091905050610e8d565b005b61033060048080359060200190919050506110ba565b604051808a73ffffffffffffffffffffffffffffffffffffffff1681526020018973ffffffffffffffffffffffffffffffffffffffff168152602001888152602001878152602001861515815260200185151581526020018415158152602001838152602001828152602001995050505050505050505060405180910390f35b6103c6600480803590602001909190505061117e565b6040518082815260200191505060405180910390f35b6103f2600480803590602001909190505061121a565b005b61040a600480803590602001909190505061133d565b6040518084600019168152602001838152602001828152602001935050505060405180910390f35b6104516004808035906020019091908035906020019091905050611373565b005b61046960048080359060200190919050506113d3565b005b600460005060205280600052604060002060009150905080600001600050549080600101600050908060020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060030160005054908060040160005054908060050160005054908060060160009054906101000a900460ff16908060060160019054906101000a900460ff16905088565b60008134101561050d57610002565b338160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055508281600201600050819055508181600301600050819055506000816005016000508190555060018160040160006101000a81548160ff0219169083021790555060008160040160016101000a81548160ff0219169083021790555060008160040160026101000a81548160ff02191690830217905550600081600501600050819055506202a3004201816006016000508190555080600260005060008681526020019081526020016000206000506000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055506001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555060028201600050548160020160005055600382016000505481600301600050556004820160009054906101000a900460ff168160040160006101000a81548160ff021916908302179055506004820160019054906101000a900460ff168160040160016101000a81548160ff021916908302179055506004820160029054906101000a900460ff168160040160026101000a81548160ff0219169083021790555060058201600050548160050160005055600682016000505481600601600050559050507fbd3054274fed91db479ebd85a737fca37c2f4b759c06869c54f812a2fdd34529846040518082815260200191505060405180910390a15b50505050565b6000828160000160005081905550600081600101600050819055506000816002016000508190555080600060005060008473ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000506000820160005054816000016000505560018201600050548160010160005055600282016000505481600201600050559050505b505050565b60006000826002600050600082815260200190815260200160002060005060040160009054906101000a900460ff16156109cf576002600050600085815260200190815260200160002060005092508260040160009054906101000a900460ff16158061089857508260040160019054906101000a900460ff165b156108a257610002565b60003414156108b057610002565b600060005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005091506103e882600101600050541080156108ff5750826002016000505434105b1561090d5761000256610925565b600283600201600050540434101561092457610002565b5b338360000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555034836005016000508190555060018360040160016101000a81548160ff021916908302179055507f43842b7e6fc1b2b0f1b4b54f269a2f692ff01277e325c50600d2a1920a7349cf8433604051808381526020018273ffffffffffffffffffffffffffffffffffffffff1681526020019250505060405180910390a15b505b505050565b60016000506020528060005260406000206000915090508060000160005054908060010160005054905082565b60006000600060010260001916600060005060003373ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050600001600050546000191614158015610a995750600060010260001916600160005060003373ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050600001600050546000191614155b15610e10573073ffffffffffffffffffffffffffffffffffffffff1631831115610ac257610002565b84816000016000508190555083816001016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610b1f57805160ff1916838001178555610b50565b82800160010185558215610b50579182015b82811115610b4f578251826000505591602001919060010190610b31565b5b509050610b7b9190610b5d565b80821115610b775760008181506000905550600101610b5d565b5090565b5050338160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055508281600301600050819055506000816004016000508190555060023073ffffffffffffffffffffffffffffffffffffffff163104816005016000508190555060018160060160006101000a81548160ff0219169083021790555060008160060160016101000a81548160ff02191690830217905550806004600050600060036000505481526020019081526020016000206000506000820160005054816000016000505560018201600050816001016000509080546001816001161561010002031660029004828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610ca95780548555610ce6565b82800160010185558215610ce657600052602060002091601f016020900482015b82811115610ce5578254825591600101919060010190610cca565b5b509050610d119190610cf3565b80821115610d0d5760008181506000905550600101610cf3565b5090565b50506002820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055506003820160005054816003016000505560048201600050548160040160005055600582016000505481600501600050556006820160009054906101000a900460ff168160060160006101000a81548160ff021916908302179055506006820160019054906101000a900460ff168160060160016101000a81548160ff02191690830217905550905050600160036000828282505401925050819055506001600360005054039150610e11565b5b509392505050565b60008281600001600050819055506000816001016000508190555080600160005060008473ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005060008201600050548160000160005055600182016000505481600101600050559050505b505050565b6000600060010260001916600060005060003373ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050600001600050546000191614158015610f215750600060010260001916600160005060003373ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050600001600050546000191614155b156110b557600460005060008381526020019081526020016000206000509050600115158160070160005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615151415610f8e57610002565b600060010260001916600060005060003373ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000506000016000505460001916141561102557600160005060003373ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050600101600050548160040160008282825054019250508190555061106f565b600060005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005060020160005054816004016000828282505401925050819055505b60018160070160005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908302179055505b5b5050565b60026000506020528060005260406000206000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060020160005054908060030160005054908060040160009054906101000a900460ff16908060040160019054906101000a900460ff16908060040160029054906101000a900460ff16908060050160005054908060060160005054905089565b600060006000600060005060003373ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000509150600260005060008581526020019081526020016000206000506002016000505490506103e8826001016000505410156111f45780925061121356611212565b6103e8826001016000505410151561121157600281049250611213565b5b5b5050919050565b6000816002600050600082815260200190815260200160002060005060040160009054906101000a900460ff161561133757600260005060008481526020019081526020016000206000509150816006016000505442101580156112935750600015158260040160029054906101000a900460ff161515145b15611336578160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1660008360030160005054846005016000505401604051809050600060405180830381858888f193505050505060008260040160006101000a81548160ff0219169083021790555060008260040160016101000a81548160ff021916908302179055505b5b505b5050565b60006000506020528060005260406000206000915090508060000160005054908060010160005054908060020160005054905083565b60648111806113825750600081105b1561138c57610002565b80600060005060008473ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000506001016000828282505401925050819055505b5050565b806002600050600082815260200190815260200160002060005060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614156114bf57816002600050600082815260200190815260200160002060005060040160009054906101000a900460ff16156114bd577f3ec814dcd09389165b2f880384a88abebc497d61110816a41752a798d023441b8342604051808381526020018281526020019250505060405180910390a16114bc836114c4565b5b505b505b50565b60006002600050600083815260200190815260200160002060005090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1660008260050160005054600284600301600050540401604051809050600060405180830381858888f19350505050508060020160005054600060005060008360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000506002016000828282505401925050819055508060020160005054600160005060008360010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005060010160008282825054019250508190555060008160040160006101000a81548160ff0219169083021790555060008160040160016101000a81548160ff0219169083021790555060018160040160026101000a81548160ff021916908302179055505b505056',
         gas: 3000000
       }, function (er, contract) {
        console.log(er, contract);
        if (typeof contract.address !== 'undefined') {
          orderdata.address = contract.address;

          // Add user as shipper
          deliverdao.addShipper("Shipper1", web3.eth.accounts[0], {from: web3.eth.accounts[0], gas: 300000}, function(error, data) {

            if (!error) {

              // We submit a new order with ID 1
              deliverdao.makeOrder(1, web3.toWei(orderdata.value, "ether"), web3.toWei(orderdata.fee, "ether"), {from: web3.eth.accounts[0], value: web3.toWei(orderdata.fee, "ether"), gas: 600000}, function(e, s) {
                if (!e) {
                  Meteor.call('newOrder', orderdata, function(err, success) {
                    if (!err) {
                      console.log(success)
                      FlowRouter.go('/package/' + success);
                    }
                  })
                }
              })
            }
          });
        }
     })
  }
})
